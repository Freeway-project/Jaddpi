name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.4.1'

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /home/ubuntu/Jaddpi || exit 1

            # Pull latest changes from main
            echo "ğŸ“¥ Pulling latest changes from main branch..."
            git pull origin main

            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down

            # Export Firebase public config env vars (read from .env on VPS)
            # These are needed for the web app build to generate firebase-messaging-sw.js
            export $(cat .env | grep '^NEXT_PUBLIC_FIREBASE_' | xargs)

            # Build the frontend
            echo "ğŸ”¨ Building the frontend..."
            cd apps/web || exit 1
            pnpm install
            pnpm run build
            cd - || exit 1

            # Build new images
            echo "ğŸ”¨ Building Docker images..."
            docker compose build --no-cache

            # Start containers
            echo "â–¶ï¸  Starting containers..."
            docker compose up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 10

            # Check container status
            echo "ğŸ“Š Container status:"
            docker compose ps

            # Check server health
            echo "ğŸ¥ Checking server health..."
            for i in {1..30}; do
              if curl -s http://localhost:5000/health > /dev/null 2>&1; then
                echo "âœ… Server is healthy!"
                break
              fi
              echo "Attempt $i/30: Server not ready yet..."
              sleep 2
            done

            # Clean up old images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "âœ… Deployment completed successfully!"

      - name: Capture and Display Logs on Failure
        if: failure()
        run: |
          echo "ğŸš¨ Deployment failed. Capturing logs..."
          docker compose logs > deployment-logs.txt
          echo "ğŸ“„ Deployment logs saved to deployment-logs.txt"
          echo "ğŸ” Displaying the last 100 lines of logs:"
          tail -n 100 deployment-logs.txt

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment to VPS succeeded"
          else
            echo "âŒ Deployment to VPS failed"
            exit 1